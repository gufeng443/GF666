<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp群组成员添加分析工具 - 多格式支持</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-top: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .description {
            text-align: center;
            margin-bottom: 25px;
            color: #7f8c8d;
            line-height: 1.5;
            padding: 0 10px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            background: #f8f9fa;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            border: 1px solid #ddd;
            border-bottom: none;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .input-method {
            flex: 1;
            min-width: 300px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .input-method h2 {
            margin-bottom: 15px;
            color: #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-method h2 i {
            font-size: 24px;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .drop-area {
            border: 3px dashed #3498db;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        .drop-area.highlight {
            background-color: rgba(52, 152, 219, 0.1);
            border-color: #2980b9;
        }
        
        .drop-area p {
            margin: 10px 0;
            font-size: 16px;
            color: #7f8c8d;
        }
        
        .drop-area .icon {
            font-size: 40px;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .format-info {
            background: #e8f4fc;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .format-info h3 {
            margin-bottom: 10px;
            color: #3498db;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .format-examples {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.5;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .file-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 10px;
            background: white;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .file-name {
            font-size: 14px;
            font-weight: 500;
        }
        
        .file-size {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .file-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: 10px;
        }
        
        .status-pending {
            background-color: #f39c12;
            color: white;
        }
        
        .status-completed {
            background-color: #2ecc71;
            color: white;
        }
        
        .status-error {
            background-color: #e74c3c;
            color: white;
        }
        
        .remove-file {
            color: #e74c3c;
            cursor: pointer;
            padding: 5px;
            margin-left: 10px;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-success {
            background-color: #2ecc71;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: #f39c12;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .actions {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        
        .results-section {
            display: none;
            margin-top: 30px;
        }
        
        .stats-container {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-bottom: 20px;
            gap: 15px;
        }
        
        .stat-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            min-width: 200px;
            flex: 1;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .results-table th, .results-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .results-table th {
            background-color: #3498db;
            color: white;
            font-weight: 500;
            cursor: pointer;
        }
        
        .results-table th:hover {
            background-color: #2980b9;
        }
        
        .results-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .results-table tr:hover {
            background-color: #e8f4fc;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            background-color: #2ecc71;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.4s;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification.error {
            background-color: #e74c3c;
        }
        
        .notification.warning {
            background-color: #f39c12;
        }
        
        .progress-container {
            margin-top: 20px;
            display: none;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s;
        }
        
        .status-text {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        footer {
            margin-top: 30px;
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .sample-data {
            margin-top: 15px;
            font-size: 13px;
            color: #7f8c8d;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .sample-data:hover {
            color: #3498db;
            text-decoration: underline;
        }
        
        .file-count {
            margin-top: 10px;
            font-size: 14px;
            color: #7f8c8d;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .input-section {
                flex-direction: column;
            }
            
            .input-method {
                min-width: 100%;
            }
            
            .stats-container {
                flex-direction: column;
            }
            
            .stat-box {
                width: 100%;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                margin-bottom: 5px;
                font-size: 14px;
                padding: 8px 12px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 13px;
            }
            
            .format-info {
                padding: 10px;
            }
            
            .format-examples {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-users"></i> WhatsApp群组成员添加分析工具</h1>
        <p class="description">支持安卓和苹果版WhatsApp群组聊天记录分析，统计每个号码添加新成员的次数</p>
        
        <div class="tabs">
            <div class="tab active" data-tab="chat">聊天记录分析</div>
            <div class="tab" data-tab="csv">CSV数据整合</div>
        </div>
        
        <div class="tab-content active" id="chat-tab">
            <div class="input-method">
                <h2><i class="fas fa-file-alt"></i> 批量导入聊天记录</h2>
                <div class="drop-area" id="chatDropArea">
                    <div class="icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <p>将WhatsApp聊天记录文件拖放到此处</p>
                    <p>支持多个TXT文件同时导入</p>
                    <p>或</p>
                    <button class="btn" id="chatBrowseBtn"><i class="fas fa-folder-open"></i> 选择文件</button>
                    <input type="file" id="chatFileInput" accept=".txt" multiple style="display: none;">
                </div>
                
                <div class="format-info">
                    <h3><i class="fas fa-info-circle"></i> 支持的格式</h3>
                    <p>本工具支持安卓和苹果版WhatsApp导出的群组记录：</p>
                    <div class="format-examples">
                        <div><strong>安卓版格式:</strong></div>
                        <div>2025/9/9 16:20 - +91 89583 86390添加了你</div>
                        <div>2025/9/9 16:20 - +91 96910 33017添加了+55 83 9888-6644</div>
                        <br>
                        <div><strong>苹果版格式:</strong></div>
                        <div>[2025/9/9 15:36:53] +965 6629 1246: +91 93402 23643添加了+965 6629 1246。轻触可更改谁可以添加其他成员。</div>
                    </div>
                </div>
                
                <div class="file-count" id="chatFileCount">已选择 0 个文件</div>
                
                <div class="file-list" id="chatFileList">
                    <div class="empty-message">暂无文件</div>
                </div>
                
                <div class="actions">
                    <button class="btn" id="analyzeBtn" disabled><i class="fas fa-chart-pie"></i> 分析数据</button>
                    <button class="btn btn-danger" id="clearChatBtn" disabled><i class="fas fa-trash"></i> 清除列表</button>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="csv-tab">
            <div class="input-method">
                <h2><i class="fas fa-file-csv"></i> 批量导入CSV文件</h2>
                <div class="drop-area" id="csvDropArea">
                    <div class="icon"><i class="fas fa-file-import"></i></div>
                    <p>将CSV统计文件拖放到此处</p>
                    <p>支持多个CSV文件同时导入</p>
                    <p>或</p>
                    <button class="btn" id="csvBrowseBtn"><i class="fas fa-folder-open"></i> 选择CSV文件</button>
                    <input type="file" id="csvFileInput" accept=".csv" multiple style="display: none;">
                </div>
                
                <div class="file-count" id="csvFileCount">已选择 0 个文件</div>
                
                <div class="file-list" id="csvFileList">
                    <div class="empty-message">暂无CSV文件</div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-warning" id="mergeCsvBtn" disabled><i class="fas fa-object-group"></i> 整合数据</button>
                    <button class="btn btn-danger" id="clearCsvBtn" disabled><i class="fas fa-trash"></i> 清除列表</button>
                </div>
            </div>
        </div>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
            <div class="status-text" id="statusText">准备中...</div>
        </div>
        
        <div class="results-section" id="resultsSection">
            <div class="stats-container">
                <div class="stat-box">
                    <div class="stat-number" id="totalAdds">0</div>
                    <div class="stat-label">总添加次数</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="uniqueNumbers">0</div>
                    <div class="stat-label">唯一添加者号码</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="topAdderCount">0</div>
                    <div class="stat-label">最高添加次数</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="topAdder">-</div>
                    <div class="stat-label">最多添加者</div>
                </div>
            </div>
            
            <h2><i class="fas fa-table"></i> 添加成员统计</h2>
            <div class="table-container">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th data-sort="number">号码 <i class="fas fa-sort"></i></th>
                            <th data-sort="count">添加次数 <i class="fas fa-sort"></i></th>
                            <th data-sort="percentage">百分比 <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <!-- 结果将在这里动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" id="exportBtn"><i class="fas fa-download"></i> 导出统计结果</button>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span>分析完成！</span>
    </div>
    
    <footer>
        <p>© 2023 WhatsApp群组成员添加分析工具 | 使用HTML5 File API实现</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 元素引用
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const chatDropArea = document.getElementById('chatDropArea');
            const chatFileInput = document.getElementById('chatFileInput');
            const chatBrowseBtn = document.getElementById('chatBrowseBtn');
            const chatFileList = document.getElementById('chatFileList');
            const chatFileCount = document.getElementById('chatFileCount');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const clearChatBtn = document.getElementById('clearChatBtn');
            const csvDropArea = document.getElementById('csvDropArea');
            const csvFileInput = document.getElementById('csvFileInput');
            const csvBrowseBtn = document.getElementById('csvBrowseBtn');
            const csvFileList = document.getElementById('csvFileList');
            const csvFileCount = document.getElementById('csvFileCount');
            const mergeCsvBtn = document.getElementById('mergeCsvBtn');
            const clearCsvBtn = document.getElementById('clearCsvBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('statusText');
            const notification = document.getElementById('notification');
            const resultsSection = document.getElementById('resultsSection');
            const resultsBody = document.getElementById('resultsBody');
            const totalAddsElement = document.getElementById('totalAdds');
            const uniqueNumbersElement = document.getElementById('uniqueNumbers');
            const topAdderElement = document.getElementById('topAdder');
            const topAdderCountElement = document.getElementById('topAdderCount');
            const exportBtn = document.getElementById('exportBtn');
            
            // 数据存储
            let chatFiles = [];
            let csvFiles = [];
            let addersData = {};
            let currentSort = { column: 'count', direction: 'desc' };
            
            // 标签切换功能
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // 更新标签状态
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // 更新内容显示
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabId}-tab`) {
                            content.classList.add('active');
                        }
                    });
                });
            });
            
            // 聊天记录文件处理
            chatBrowseBtn.addEventListener('click', () => {
                chatFileInput.click();
            });
            
            chatFileInput.addEventListener('change', (e) => {
                handleChatFiles(e.target.files);
            });
            
            // 聊天记录拖放处理
            setupDropZone(chatDropArea, handleChatFiles);
            
            function handleChatFiles(files) {
                if (!files.length) return;
                
                let addedCount = 0;
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // 验证文件类型
                    if (file.type !== 'text/plain' && !file.name.toLowerCase().endsWith('.txt')) {
                        showNotification(`文件 "${file.name}" 不是TXT格式`, true);
                        continue;
                    }
                    
                    // 检查是否已存在相同文件
                    const fileExists = chatFiles.some(f => 
                        f.name === file.name && f.size === file.size && f.lastModified === file.lastModified
                    );
                    
                    if (!fileExists) {
                        chatFiles.push(file);
                        addedCount++;
                    }
                }
                
                if (addedCount > 0) {
                    updateChatFileList();
                    showNotification(`添加了 ${addedCount} 个文件`);
                }
            }
            
            function updateChatFileList() {
                chatFileList.innerHTML = '';
                chatFileCount.textContent = `已选择 ${chatFiles.length} 个文件`;
                
                if (chatFiles.length === 0) {
                    chatFileList.innerHTML = '<div class="empty-message">暂无文件</div>';
                    analyzeBtn.disabled = true;
                    clearChatBtn.disabled = true;
                    return;
                }
                
                analyzeBtn.disabled = false;
                clearChatBtn.disabled = false;
                
                chatFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    
                    const fileInfo = document.createElement('div');
                    fileInfo.className = 'file-info';
                    
                    const fileName = document.createElement('div');
                    fileName.className = 'file-name';
                    fileName.textContent = file.name;
                    
                    const fileSize = document.createElement('div');
                    fileSize.className = 'file-size';
                    fileSize.textContent = formatFileSize(file.size);
                    
                    const fileStatus = document.createElement('div');
                    fileStatus.className = 'file-status status-pending';
                    fileStatus.textContent = '等待处理';
                    fileStatus.id = `chat-status-${index}`;
                    
                    const removeBtn = document.createElement('div');
                    removeBtn.className = 'remove-file';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.addEventListener('click', () => {
                        chatFiles.splice(index, 1);
                        updateChatFileList();
                    });
                    
                    fileInfo.appendChild(fileName);
                    fileInfo.appendChild(fileSize);
                    
                    fileItem.appendChild(fileInfo);
                    fileItem.appendChild(fileStatus);
                    fileItem.appendChild(removeBtn);
                    
                    chatFileList.appendChild(fileItem);
                });
            }
            
            // CSV文件处理
            csvBrowseBtn.addEventListener('click', () => {
                csvFileInput.click();
            });
            
            csvFileInput.addEventListener('change', (e) => {
                handleCsvFiles(e.target.files);
            });
            
            // CSV拖放处理
            setupDropZone(csvDropArea, handleCsvFiles);
            
            function handleCsvFiles(files) {
                if (!files.length) return;
                
                let addedCount = 0;
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // 验证文件类型
                    if (file.type !== 'text/csv' && !file.name.toLowerCase().endsWith('.csv')) {
                        showNotification(`文件 "${file.name}" 不是CSV格式`, true);
                        continue;
                    }
                    
                    // 检查是否已存在相同文件
                    const fileExists = csvFiles.some(f => 
                        f.name === file.name && f.size === file.size && f.lastModified === file.lastModified
                    );
                    
                    if (!fileExists) {
                        csvFiles.push(file);
                        addedCount++;
                    }
                }
                
                if (addedCount > 0) {
                    updateCsvFileList();
                    showNotification(`添加了 ${addedCount} 个CSV文件`);
                }
            }
            
            function updateCsvFileList() {
                csvFileList.innerHTML = '';
                csvFileCount.textContent = `已选择 ${csvFiles.length} 个文件`;
                
                if (csvFiles.length === 0) {
                    csvFileList.innerHTML = '<div class="empty-message">暂无CSV文件</div>';
                    mergeCsvBtn.disabled = true;
                    clearCsvBtn.disabled = true;
                    return;
                }
                
                mergeCsvBtn.disabled = false;
                clearCsvBtn.disabled = false;
                
                csvFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    
                    const fileInfo = document.createElement('div');
                    fileInfo.className = 'file-info';
                    
                    const fileName = document.createElement('div');
                    fileName.className = 'file-name';
                    fileName.textContent = file.name;
                    
                    const fileSize = document.createElement('div');
                    fileSize.className = 'file-size';
                    fileSize.textContent = formatFileSize(file.size);
                    
                    const removeBtn = document.createElement('div');
                    removeBtn.className = 'remove-file';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.addEventListener('click', () => {
                        csvFiles.splice(index, 1);
                        updateCsvFileList();
                    });
                    
                    fileInfo.appendChild(fileName);
                    fileInfo.appendChild(fileSize);
                    
                    fileItem.appendChild(fileInfo);
                    fileItem.appendChild(removeBtn);
                    
                    csvFileList.appendChild(fileItem);
                });
            }
            
            // 分析聊天记录
            analyzeBtn.addEventListener('click', analyzeChatFiles);
            
            async function analyzeChatFiles() {
                if (chatFiles.length === 0) {
                    showNotification('请先添加聊天记录文件', true);
                    return;
                }
                
                progressContainer.style.display = 'block';
                statusText.textContent = '正在分析数据...';
                
                // 重置数据
                addersData = {};
                let processedFiles = 0;
                
                for (let i = 0; i < chatFiles.length; i++) {
                    const file = chatFiles[i];
                    const statusElement = document.getElementById(`chat-status-${i}`);
                    
                    if (statusElement) {
                        statusElement.textContent = '处理中...';
                        statusElement.className = 'file-status status-pending';
                    }
                    
                    try {
                        const content = await readFileAsText(file);
                        const lines = content.split('\n');
                        
                        // 用于匹配添加者号码的正则表达式 - 兼容安卓/iOS、多国区号与多种分隔符/控制符
                        // 说明：
                        // - 允许 +国家码 后跟数字、空格、普通短横、中文/不可断短横、括号等
                        // - 清洗时会去除括号、空格、短横、NBSP、窄不换行空格、RTL/LTR 控制符
                        // - iOS 行通常为：[日期时间] 名称: +XX ... 添加了 ...，名称和号码两侧可能带有不可见控制符
                        const androidRegex = /-\s*[\u200E\u200F\u202A-\u202E]*(\+\d{1,3}[\d\s\-()\u2011\u00A0\u202F]{5,30})[\u200E\u200F\u202A-\u202E]*\s*添加了/;
                        const iosRegex = /^\[[^\]]+\]\s.*?[：:]\s*[\u200E\u200F\u202A-\u202E]*(\+\d{1,3}[\d\s\-()\u2011\u00A0\u202F]{5,30})[\u200E\u200F\u202A-\u202E]*\s*添加了/;
                        
                        let fileAdds = 0;
                        for (const line of lines) {
                            const normalizedLine = normalizeText(line);
                            let match = normalizedLine.match(androidRegex);
                            if (!match) {
                                match = normalizedLine.match(iosRegex);
                            }
                            // 简化兜底：直接寻找“号码 添加了”，无需依赖前缀结构
                            if (!match) {
                                const phonePattern = /\+\d{1,3}[\d\s\-()\u2011\u00A0\u202F]{5,30}/.source;
                                const fallbackRegex = new RegExp(`(${phonePattern})[\u200E\u200F\u202A-\u202E]*\\s*添加了`);
                                match = normalizedLine.match(fallbackRegex);
                            }
                            
                            if (match) {
                                // 统一号码：去除括号/空格/短横/不间断空格/窄不换行空格/Unicode 控制符
                                const cleaned = match[1]
                                    .replace(/[\u200E\u200F\u202A-\u202E]/g, '')
                                    .replace(/[()]/g, '')
                                    .replace(/[\s\-\u2011\u00A0\u202F]/g, '');
                                const adderNumber = cleaned;
                                
                                if (addersData[adderNumber]) {
                                    addersData[adderNumber]++;
                                } else {
                                    addersData[adderNumber] = 1;
                                }
                                
                                fileAdds++;
                            }
                        }
                        
                        if (statusElement) {
                            statusElement.textContent = `完成 (${fileAdds}条)`;
                            statusElement.className = 'file-status status-completed';
                        }
                    } catch (error) {
                        console.error(`处理文件 ${file.name} 时出错:`, error);
                        if (statusElement) {
                            statusElement.textContent = '出错';
                            statusElement.className = 'file-status status-error';
                        }
                        showNotification(`处理文件 ${file.name} 时出错`, true);
                    }
                    
                    processedFiles++;
                    const progress = (processedFiles / chatFiles.length) * 100;
                    progressBar.style.width = `${progress}%`;
                    statusText.textContent = `处理进度: ${processedFiles}/${chatFiles.length} (${Math.round(progress)}%)`;
                }
                
                progressContainer.style.display = 'none';
                displayResults();
                showNotification(`分析完成！处理了 ${chatFiles.length} 个文件`);
            }
            
            // 整合CSV数据
            mergeCsvBtn.addEventListener('click', mergeCsvFiles);
            
            async function mergeCsvFiles() {
                if (csvFiles.length === 0) {
                    showNotification('请先添加CSV文件', true);
                    return;
                }
                
                progressContainer.style.display = 'block';
                statusText.textContent = '正在整合CSV文件...';
                
                // 重置数据
                addersData = {};
                let processedFiles = 0;
                
                for (const file of csvFiles) {
                    try {
                        const content = await readFileAsText(file);
                        const lines = content.split('\n');
                        
                        // 跳过标题行
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            // 解析CSV行：号码,添加次数,百分比
                            const parts = line.split(',');
                            if (parts.length >= 2) {
                                const number = parts[0].replace(/"/g, '').trim();
                                const count = parseInt(parts[1], 10) || 0;
                                
                                if (number && !isNaN(count)) {
                                    if (addersData[number]) {
                                        addersData[number] += count;
                                    } else {
                                        addersData[number] = count;
                                    }
                                }
                            }
                        }
                        
                        processedFiles++;
                        const progress = (processedFiles / csvFiles.length) * 100;
                        progressBar.style.width = `${progress}%`;
                        statusText.textContent = `处理进度: ${processedFiles}/${csvFiles.length} (${Math.round(progress)}%)`;
                    } catch (error) {
                        console.error(`处理文件 ${file.name} 时出错:`, error);
                        showNotification(`处理文件 ${file.name} 时出错`, true);
                    }
                }
                
                progressContainer.style.display = 'none';
                displayResults();
                showNotification(`CSV文件整合完成！共处理了 ${csvFiles.length} 个文件`);
            }
            
            // 清除文件列表
            clearChatBtn.addEventListener('click', () => {
                chatFiles = [];
                updateChatFileList();
                showNotification('聊天记录文件列表已清除');
            });
            
            clearCsvBtn.addEventListener('click', () => {
                csvFiles = [];
                updateCsvFileList();
                showNotification('CSV文件列表已清除');
            });
            
            // 显示结果
            function displayResults() {
                // 计算统计数据
                const adders = Object.keys(addersData);
                const totalAdds = Object.values(addersData).reduce((sum, count) => sum + count, 0);
                const uniqueNumbers = adders.length;
                
                // 找到添加次数最多的号码
                let topAdder = '';
                let maxAdds = 0;
                
                for (const [number, count] of Object.entries(addersData)) {
                    if (count > maxAdds) {
                        maxAdds = count;
                        topAdder = number;
                    }
                }
                
                // 更新统计数据
                totalAddsElement.textContent = totalAdds.toLocaleString();
                uniqueNumbersElement.textContent = uniqueNumbers.toLocaleString();
                topAdderElement.textContent = topAdder ? formatPhoneNumber(topAdder) : '-';
                topAdderCountElement.textContent = maxAdds.toLocaleString();
                
                // 排序并显示结果
                sortTable(currentSort.column, currentSort.direction);
                updateTableHeaders(currentSort.column, currentSort.direction);
                
                // 显示结果区域
                resultsSection.style.display = 'block';
            }
            
            // 表格排序
            document.querySelectorAll('.results-table th').forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.getAttribute('data-sort');
                    if (column === currentSort.column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'desc';
                    }
                    
                    sortTable(column, currentSort.direction);
                    updateTableHeaders(column, currentSort.direction);
                });
            });
            
            function sortTable(column, direction) {
                const addersArray = Object.entries(addersData);
                const totalAdds = Object.values(addersData).reduce((sum, count) => sum + count, 0);
                
                addersArray.sort((a, b) => {
                    let valueA, valueB;
                    
                    switch(column) {
                        case 'number':
                            valueA = a[0];
                            valueB = b[0];
                            break;
                        case 'count':
                            valueA = a[1];
                            valueB = b[1];
                            break;
                        case 'percentage':
                            valueA = (a[1] / totalAdds) * 100;
                            valueB = (b[1] / totalAdds) * 100;
                            break;
                        default:
                            valueA = a[1];
                            valueB = b[1];
                    }
                    
                    if (typeof valueA === 'string') {
                        return direction === 'asc' ? valueA.localeCompare(valueB) : valueB.localeCompare(valueA);
                    } else {
                        return direction === 'asc' ? valueA - valueB : valueB - valueA;
                    }
                });
                
                // 清空结果表格
                resultsBody.innerHTML = '';
                
                // 填充结果表格
                const totalAddsValue = Object.values(addersData).reduce((sum, count) => sum + count, 0);
                
                for (const [number, count] of addersArray) {
                    const percentage = ((count / totalAddsValue) * 100).toFixed(1);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatPhoneNumber(number)}</td>
                        <td>${count.toLocaleString()}</td>
                        <td>${percentage}%</td>
                    `;
                    
                    resultsBody.appendChild(row);
                }
            }
            
            function updateTableHeaders(sortedColumn, direction) {
                // 更新所有表头
                document.querySelectorAll('.results-table th').forEach(header => {
                    const column = header.getAttribute('data-sort');
                    const icon = header.querySelector('i');
                    
                    if (column === sortedColumn) {
                        icon.className = direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
                    } else {
                        icon.className = 'fas fa-sort';
                    }
                });
            }
            
            // 导出结果
            exportBtn.addEventListener('click', exportResults);
            
            function exportResults() {
                if (Object.keys(addersData).length === 0) {
                    showNotification('没有数据可导出', true);
                    return;
                }
                
                let csvContent = "号码,添加次数,百分比\n";
                const totalAdds = Object.values(addersData).reduce((sum, count) => sum + count, 0);
                
                // 按添加次数降序排序
                const sortedAdders = Object.entries(addersData)
                    .sort((a, b) => b[1] - a[1]);
                
                for (const [number, count] of sortedAdders) {
                    const percentage = ((count / totalAdds) * 100).toFixed(1);
                    csvContent += `"${formatPhoneNumber(number)}",${count},${percentage}%\n`;
                }
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "whatsapp_添加统计.csv");
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('导出完成！');
            }
            
            // 辅助函数
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            function formatPhoneNumber(number) {
                // 格式化电话号码显示
                if (number.startsWith('+91') && number.length === 13) {
                    return `+91 ${number.substring(3, 8)} ${number.substring(8)}`;
                }
                return number;
            }
            
            function readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = event => {
                        resolve(event.target.result);
                    };
                    
                    reader.onerror = error => {
                        reject(error);
                    };
                    
                    reader.readAsText(file);
                });
            }
            
            function normalizeText(text) {
                // 统一文本：去除常见方向控制符，将全角冒号转半角，去除不可见 NBSP/窄不换行空格周围多余空白
                return text
                    .replace(/[\u200E\u200F\u202A-\u202E]/g, '')
                    .replace(/：/g, ':')
                    .replace(/[\u00A0\u202F\u2007]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
            }

            function setupDropZone(dropZone, handler) {
                // 拖放事件处理
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, preventDefaults, false);
                });
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => {
                        dropZone.classList.add('highlight');
                    }, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => {
                        dropZone.classList.remove('highlight');
                    }, false);
                });
                
                // 处理文件拖放
                dropZone.addEventListener('drop', e => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    if (files.length) {
                        handler(files);
                    }
                }, false);
            }
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // 显示通知
            function showNotification(message, isError = false) {
                const notificationIcon = notification.querySelector('i');
                const notificationText = notification.querySelector('span');
                
                notificationText.textContent = message;
                
                if (isError) {
                    notification.className = 'notification error';
                    notificationIcon.className = 'fas fa-exclamation-circle';
                } else {
                    notification.className = 'notification';
                    notificationIcon.className = 'fas fa-check-circle';
                }
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        });
    </script>
</body>
</html>